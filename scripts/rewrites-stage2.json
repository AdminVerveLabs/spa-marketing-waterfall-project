{
  "Skip - No Website": "// For companies without a website, pass through with empty enrichment\n// but still check domain for booking platform signals\nconst items = $input.all();\nconst results = [];\n\nconst bookingSignatures = {\n  'jane_app': ['jane.app', 'janeapp.com'],\n  'acuity': ['acuityscheduling.com', 'squareup.com/appointments'],\n  'mindbody': ['mindbodyonline.com', 'clients.mindbodyonline.com', 'mindbody.io'],\n  'square': ['square.site', 'squareup.com'],\n  'vagaro': ['vagaro.com'],\n  'fresha': ['fresha.com', 'shedul.com'],\n  'schedulicity': ['schedulicity.com'],\n  'schedulista': ['schedulista.com'],\n  'booksy': ['booksy.com'],\n  'massagebook': ['massagebook.com'],\n  'genbook': ['genbook.com'],\n  'noterro': ['noterro.com'],\n  'clinicsense': ['clinicsense.com'],\n  'wix_bookings': ['wix.com/booking'],\n  'calendly': ['calendly.com']\n};\n\nfor (const entry of items) {\n  const item = entry.json;\n  const domain = (item.domain || '').toLowerCase();\n\n  let booking_platform = null;\n  let has_online_booking = false;\n\n  for (const [platform, signatures] of Object.entries(bookingSignatures)) {\n    for (const sig of signatures) {\n      if (domain.includes(sig)) {\n        booking_platform = platform;\n        has_online_booking = true;\n        break;\n      }\n    }\n    if (has_online_booking) break;\n  }\n\n  results.push({\n    json: {\n      ...item,\n      _website_enrichment: {\n        has_online_booking,\n        booking_platform,\n        has_paid_ads: false,\n        estimated_size: null,\n        social_links_found: [],\n        _website_fetch_status: 'skipped_no_website'\n      }\n    }\n  });\n}\n\nreturn results;",
  "Skip Google Details": "// Companies without Google Place ID skip details fetch\nconst items = $input.all();\nconst results = [];\n\nfor (const entry of items) {\n  const company = entry.json;\n  results.push({\n    json: {\n      ...company,\n      _google_details: {\n        opening_hours: null,\n        business_status: null,\n        photo_count: 0,\n        price_level: null,\n        additional_types: [],\n        _fetch_status: 'skipped'\n      }\n    }\n  });\n}\n\nreturn results;",
  "Prepare Company Update": "const items = $input.all();\nconst results = [];\n\nfor (const entry of items) {\n  const item = entry.json;\n  const now = new Date().toISOString();\n\n  // Build the PATCH payload for Supabase\n  const updatePayload = {\n    has_online_booking: item.has_online_booking || false,\n    booking_platform: item.booking_platform || null,\n    has_paid_ads: item.has_paid_ads || false,\n    estimated_size: item.estimated_size || null,\n    enrichment_status: 'partially_enriched',\n    enriched_at: now\n  };\n\n  // Include backfill data ONLY from companies that went through the backfill path\n  // This prevents 409 conflicts when PATCHing domain on companies that already have one\n  const backfill = item._backfill_patch || {};\n  if (backfill.domain) updatePayload.domain = backfill.domain;\n  if (backfill.google_place_id) updatePayload.google_place_id = backfill.google_place_id;\n  if (backfill.google_rating) updatePayload.google_rating = backfill.google_rating;\n  if (backfill.google_review_count) updatePayload.google_review_count = backfill.google_review_count;\n\n  // has_website can change via website analysis (not just backfill)\n  if (item.has_website) updatePayload.has_website = item.has_website;\n\n  // Include website-scraped email if found (BUG-F012 fix: read from flat field)\n  const websiteEmail = item._best_email || null;\n  if (websiteEmail) {\n    updatePayload.email = websiteEmail;\n    // email_status stays NULL - will be verified in Step 4\n  }\n\n  results.push({\n    json: {\n      _company_id: item.id,\n      _update_payload: updatePayload,\n      // Pass through everything for social discovery\n      ...item\n    }\n  });\n}\n\nreturn results;",
  "Prepare Social Profiles Insert": "// Insert social profiles found from website HTML into Supabase social_profiles table\nconst items = $input.all();\nconst results = [];\n\nfor (const entry of items) {\n  const item = entry.json;\n  const links = item.social_links_found || [];\n\n  if (links.length === 0) {\n    results.push({ json: { _social_inserts: 0, company_id: item.company_id } });\n    continue;\n  }\n\n  // Build an array of social_profiles rows\n  const rows = links.map(link => ({\n    company_id: item.company_id,\n    platform: link.platform,\n    profile_url: link.url,\n    follower_count: null,\n    post_count: null,\n    last_post_date: null,\n    scraped_at: new Date().toISOString()\n  }));\n\n  results.push({\n    json: {\n      _social_rows: rows,\n      _social_inserts: rows.length,\n      company_id: item.company_id,\n      company_name: item.company_name,\n      city: item.city,\n      state: item.state,\n      needs_social_discovery: false\n    }\n  });\n}\n\nreturn results;",
  "Build SociaVault Request": "const items = $input.all();\nconst results = [];\nconst config = $('Step 3b Config').first().json;\nconst baseUrl = 'https://api.sociavault.com/v1/scrape';\n\nconst skipMap = {\n  instagram: config.skip_instagram,\n  facebook: config.skip_facebook,\n  tiktok: config.skip_tiktok,\n  x: config.skip_twitter,\n  twitter: config.skip_twitter,\n  linkedin: config.skip_linkedin,\n  youtube: config.skip_youtube\n};\n\nconst invalidHandles = [\n  'sharer', 'share', 'intent', 'login', 'help', 'about', 'policies', 'privacy',\n  'hashtag', 'explore', 'watch', 'results', 'search',\n  // Facebook non-profile paths (tracking pixels, SDK, plugins, etc.)\n  'tr', 'flx', 'plugins', 'dialog', 'ajax', 'ads', 'business', 'events',\n  'groups', 'marketplace', 'gaming', 'watch', 'reels', 'stories'\n];\n\nfor (const entry of items) {\n  const profile = entry.json;\n  const platform = (profile.platform || '').toLowerCase();\n  const url = (profile.profile_url || '').trim();\n\n  const shouldSkip = skipMap[platform] === 'true' || skipMap[platform] === true;\n  if (shouldSkip) {\n    results.push({ json: { ...profile, _skip: true, _skip_reason: `Platform ${platform} disabled`, _sociavault_url: '', _extracted_handle: '' } });\n    continue;\n  }\n\n  let handle = '';\n  try {\n    if (platform === 'instagram') {\n      const match = url.match(/instagram\\.com\\/([a-zA-Z0-9._]+)/i);\n      if (match) handle = match[1];\n    } else if (platform === 'facebook') {\n      const profileIdMatch = url.match(/profile\\.php\\?id=(\\d+)/);\n      if (profileIdMatch) {\n        handle = profileIdMatch[1];\n      } else {\n        const match = url.match(/facebook\\.com\\/([a-zA-Z0-9._-]+)/i);\n        if (match) handle = match[1];\n      }\n    } else if (platform === 'tiktok') {\n      const match = url.match(/tiktok\\.com\\/@([a-zA-Z0-9._-]+)/i);\n      if (match) handle = match[1];\n    } else if (platform === 'x' || platform === 'twitter') {\n      const match = url.match(/(?:twitter|x)\\.com\\/([a-zA-Z0-9_]+)/i);\n      if (match) handle = match[1];\n    } else if (platform === 'linkedin') {\n      const companyMatch = url.match(/linkedin\\.com\\/company\\/([a-zA-Z0-9._-]+)/i);\n      const personMatch = url.match(/linkedin\\.com\\/in\\/([a-zA-Z0-9._-]+)/i);\n      handle = companyMatch ? companyMatch[1] : (personMatch ? personMatch[1] : '');\n    } else if (platform === 'youtube') {\n      const handleMatch = url.match(/youtube\\.com\\/@([a-zA-Z0-9._-]+)/i);\n      const channelMatch = url.match(/youtube\\.com\\/channel\\/([a-zA-Z0-9_-]+)/i);\n      const cMatch = url.match(/youtube\\.com\\/c\\/([a-zA-Z0-9._-]+)/i);\n      handle = handleMatch ? handleMatch[1] : (channelMatch ? channelMatch[1] : (cMatch ? cMatch[1] : ''));\n    }\n  } catch (e) {}\n\n  if (invalidHandles.includes(handle.toLowerCase())) handle = '';\n\n  if (!handle) {\n    results.push({ json: { ...profile, _skip: true, _skip_reason: `Could not extract handle from URL: ${url}`, _sociavault_url: '', _extracted_handle: '' } });\n    continue;\n  }\n\n  let sociavaultUrl = '';\n  if (platform === 'instagram') {\n    sociavaultUrl = `${baseUrl}/instagram/profile?handle=${encodeURIComponent(handle)}`;\n  } else if (platform === 'facebook') {\n    // Facebook endpoint requires the full profile URL with https://\n    let fbUrl = url;\n    if (!fbUrl.startsWith('http')) {\n      fbUrl = 'https://' + fbUrl;\n    }\n    // Ensure https (not http)\n    fbUrl = fbUrl.replace(/^http:\\/\\//, 'https://');\n    sociavaultUrl = `${baseUrl}/facebook/profile?url=${encodeURIComponent(fbUrl)}`;\n  } else if (platform === 'tiktok') {\n    sociavaultUrl = `${baseUrl}/tiktok/profile?handle=${encodeURIComponent(handle)}`;\n  } else if (platform === 'x' || platform === 'twitter') {\n    sociavaultUrl = `${baseUrl}/twitter/profile?handle=${encodeURIComponent(handle)}`;\n  } else if (platform === 'linkedin') {\n    const isCompany = url.includes('/company/');\n    sociavaultUrl = isCompany\n      ? `${baseUrl}/linkedin/company?username=${encodeURIComponent(handle)}`\n      : `${baseUrl}/linkedin/profile?username=${encodeURIComponent(handle)}`;\n  } else if (platform === 'youtube') {\n    const isChannelId = handle.startsWith('UC');\n    sociavaultUrl = isChannelId\n      ? `${baseUrl}/youtube/channel?channel_id=${encodeURIComponent(handle)}`\n      : `${baseUrl}/youtube/channel?handle=${encodeURIComponent(handle)}`;\n  }\n\n  if (!sociavaultUrl) {\n    results.push({ json: { ...profile, _skip: true, _skip_reason: `Unsupported platform: ${platform}`, _sociavault_url: '', _extracted_handle: handle } });\n    continue;\n  }\n\n  results.push({ json: { ...profile, _skip: false, _skip_reason: null, _sociavault_url: sociavaultUrl, _extracted_handle: handle, _platform: platform } });\n}\n\nreturn results;",
  "Prepare Solo Contact": "const items = $input.all();\nconst results = [];\n\nfor (const entry of items) {\n  const item = entry.json;\n  results.push({\n    json: {\n      _contact: {\n        company_id: item.id,\n        first_name: item._solo_first_name || null,\n        last_name: item._solo_last_name || null,\n        role: 'owner',\n        is_owner: true,\n        email_business: null,\n        email_personal: null,\n        phone_direct: null,\n        linkedin_url: null,\n        location: [item.city, item.state].filter(Boolean).join(', ') || null,\n        cultural_affinity: null,\n        source: 'solo_detection'\n      },\n      _company_name: item.name,\n      _company_id: item.id,\n      _source_method: 'solo_detection',\n      _has_contact: !!(item._solo_first_name)\n    }\n  });\n}\n\nreturn results;",
  "Apollo Search Only Contact": "// Apollo search found someone but enrichment is disabled - use search-only data\nconst items = $input.all();\nconst results = [];\n\nfor (const entry of items) {\n  const item = entry.json;\n  results.push({\n    json: {\n      _contact: {\n        company_id: item.id,\n        first_name: item._apollo_first_name || null,\n        last_name: null,\n        role: (item._apollo_title || '').toLowerCase().includes('owner') ? 'owner' : 'unknown',\n        is_owner: (item._apollo_title || '').toLowerCase().includes('owner'),\n        email_business: null,\n        email_personal: null,\n        phone_direct: null,\n        linkedin_url: null,\n        location: [item.city, item.state].filter(Boolean).join(', ') || null,\n        cultural_affinity: null,\n        source: 'apollo'\n      },\n      _company_name: item.name,\n      _company_id: item.id,\n      _source_method: 'apollo_search_only',\n      _has_contact: !!(item._apollo_first_name)\n    }\n  });\n}\n\nreturn results;",
  "Merge Website Results": "// Merge website-enriched (from both paths: with website and without)\nconst items = $input.all();\nconst results = [];\n// Enrichment Config is a single-item node, .first() is correct here\nconst config = $('Enrichment Config').first().json;\nconst skipGoogleDetails = config.skip_google_details === 'true' || config.skip_google_details === true;\n\nfor (const entry of items) {\n  const item = entry.json;\n  const enrichment = item._website_enrichment || {};\n\n  // Prepare the enriched company object\n  const enriched = {\n    id: item.id,\n    name: item.name,\n    phone: item.phone,\n    domain: item.domain,\n    address: item.address,\n    city: item.city,\n    state: item.state,\n    country: item.country,\n    google_place_id: item.google_place_id,\n    category: item.category,\n    has_website: item.has_website,\n    google_review_count: item.google_review_count,\n    google_rating: item.google_rating,\n    source_urls: item.source_urls,\n    on_yelp: item.on_yelp,\n    on_groupon: item.on_groupon,\n\n    // Enriched fields from website analysis\n    has_online_booking: enrichment.has_online_booking || false,\n    booking_platform: enrichment.booking_platform || null,\n    has_paid_ads: enrichment.has_paid_ads || false,\n    estimated_size: enrichment.estimated_size || null,\n\n    // Email fields from website scraping (BUG-F012 fix)\n    _emails_found: enrichment.emails_found || [],\n    _best_email: enrichment.best_email || null,\n\n    // Backfill data from Google Places lookup (BUG-F013 fix)\n    _backfill_patch: item._backfill_patch || null,\n\n    // Social links for later processing\n    _social_links_found: enrichment.social_links_found || [],\n    _website_fetch_status: enrichment._website_fetch_status || 'unknown',\n    _website_error: enrichment._website_error || null,\n    _needs_social_discovery: (enrichment.social_links_found || []).length === 0,\n    _skip_google_details: skipGoogleDetails\n  };\n\n  results.push({ json: enriched });\n}\n\nreturn results;"
}
